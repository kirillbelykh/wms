{% extends "index.html" %}

{% block content %}
<div class="max-w-5xl mx-auto mt-8">
  <h1 class="text-3xl font-bold mb-6">–ó–∞–∫–∞–∑—ã —Å–∫–ª–∞–¥–∞</h1>

  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞ -->
  <form id="create-order-form" class="flex flex-wrap gap-2 mb-6">
    <input type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞" required
           class="border rounded px-3 py-2 flex-1">
    <select name="type" required class="border rounded px-3 py-2 w-48">
      <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–∞–∫–∞–∑–∞</option>
      <option value="receiving">–ü—Ä–∏–µ–º–∫–∞</option>
      <option value="shipping">–û—Ç–≥—Ä—É–∑–∫–∞</option>
      <option value="movement">–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</option>
    </select>
    <input type="number" name="quantity" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" min="1"
           class="border rounded px-3 py-2 w-32">
    <input type="text" name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"
           class="border rounded px-3 py-2 flex-1">
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">–°–æ–∑–¥–∞—Ç—å</button>
  </form>

  <!-- –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ -->
  <ul id="orders-list" class="space-y-4">
    {% for order in orders %}
    <li data-id="{{ order.id }}" class="flex justify-between items-center p-4 border rounded hover:shadow">
      <div>
        <h2 class="font-semibold text-lg">{{ order.name }}</h2>
        <p class="text-gray-500">{{ order.description or '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è' }}</p>
        <p class="text-sm text-gray-400">–¢–∏–ø: {{ order.type }} | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {{ order.quantity }} | –°—Ç–∞—Ç—É—Å: {{ order.status }}</p>
      </div>
      <div class="flex gap-2">
        <button onclick="deleteOrder({{ order.id }}, this)" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
      </div>
    </li>
    {% else %}
      <li class="text-gray-400">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</li>
    {% endfor %}
  </ul>
</div>

<script>
const form = document.getElementById('create-order-form');
const list = document.getElementById('orders-list');

// –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(form);

  try {
    const response = await fetch('/orders/create', {
      method: 'POST',
      body: formData
    });

    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞');

    // –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–π —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ —á–µ—Ä–µ–∑ GET
    const ordersResponse = await fetch('/orders/');
    const html = await ordersResponse.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");
    const updatedList = doc.getElementById('orders-list');
    if (updatedList) {
      list.innerHTML = updatedList.innerHTML;
      form.reset();
    }
  } catch (err) {
    console.error(err);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
  }
});

// –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
async function deleteOrder(orderId, button) {
  if (!confirm('–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) return;

  try {
    const response = await fetch(`/orders/delete/${orderId}`, { method: 'GET' });
    if (response.ok) {
      button.closest('li').remove();
    } else {
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑');
    }
  } catch (err) {
    console.error(err);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
  }
}
</script>
{% endblock %}