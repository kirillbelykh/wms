{% extends "index.html" %}

{% block content %}
<div class="max-w-5xl mx-auto mt-8">
  <h1 class="text-3xl font-bold mb-6">–ü—Ä–∏–µ–º–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥</h1>

  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –ø—Ä–∏–µ–º–∫–∏ -->
  <form id="create-receiving-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <input type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" required
           class="border rounded px-3 py-2 w-full">
    <input type="number" name="quantity" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" step="1" required
           class="border rounded px-3 py-2 w-full">
    <input type="text" name="barcode" placeholder="–®—Ç—Ä–∏—Ö–∫–æ–¥" required
           class="border rounded px-3 py-2 w-full">
    <input type="text" name="country" placeholder="–°—Ç—Ä–∞–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞"
           class="border rounded px-3 py-2 w-full">
    <input type="text" name="type" placeholder="–¢–∏–ø —Ç–æ–≤–∞—Ä–∞"
           class="border rounded px-3 py-2 w-full">
    <input type="text" name="unit_of_measure" placeholder="–ï–¥. –∏–∑–º–µ—Ä–µ–Ω–∏—è"
           class="border rounded px-3 py-2 w-full">
    <input type="text" name="comments" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
           class="border rounded px-3 py-2 w-full">
    <select name="order_id" required class="border rounded px-3 py-2 w-full">
      <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑</option>
      {% for order in orders %}
      <option value="{{ order.id }}">{{ order.name }}</option>
      {% endfor %}
    </select>
    <select name="item_id" required class="border rounded px-3 py-2 w-full">
      <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>
      {% for item in items %}
      <option value="{{ item.id }}">{{ item.name }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded col-span-full">–°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–µ–º–∫—É</button>
  </form>

  <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–∏–µ–º–æ–∫ -->
  <ul id="receivings-list" class="space-y-4">
    {% for rec in receivings %}
    <li data-id="{{ rec.id }}" class="flex justify-between items-center p-4 border rounded hover:shadow">
      <div>
        <h2 class="font-semibold text-lg">{{ rec.name }}</h2>
        <p class="text-gray-500">–®–ö: {{ rec.barcode }} | –ö–æ–ª-–≤–æ: {{ rec.quantity }} | –°—Ç–∞—Ç—É—Å: {{ rec.status }}</p>
        <p class="text-sm text-gray-400">{{ rec.country }} | {{ rec.type }} | {{ rec.unit_of_measure }}</p>
        {% if rec.comments %}<p class="text-sm text-gray-500 italic">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {{ rec.comments }}</p>{% endif %}
      </div>
      <button onclick="deleteReceiving({{ rec.id }}, this)" class="text-red-500 hover:text-red-700 ml-4">üóëÔ∏è</button>
    </li>
    {% else %}
    <li>–ù–µ—Ç –ø—Ä–∏–µ–º–æ–∫</li>
    {% endfor %}
  </ul>
</div>

<script>
const form = document.getElementById('create-receiving-form');
const list = document.getElementById('receivings-list');

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(form);

  try {
    const response = await fetch('/receivings/create', {
      method: 'POST',
      body: formData
    });

    const receiving = await response.json();
    if (receiving.id) {
      const li = document.createElement('li');
      li.dataset.id = receiving.id;
      li.className = 'flex justify-between items-center p-4 border rounded hover:shadow';
      li.innerHTML = `
        <div>
          <h2 class="font-semibold text-lg">${receiving.name}</h2>
          <p class="text-gray-500">–®–ö: ${receiving.barcode} | –ö–æ–ª-–≤–æ: ${receiving.quantity} | –°—Ç–∞—Ç—É—Å: ${receiving.status}</p>
          <p class="text-sm text-gray-400">${receiving.country || ""} | ${receiving.type || ""} | ${receiving.unit_of_measure || ""}</p>
          ${receiving.comments ? `<p class="text-sm text-gray-500 italic">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${receiving.comments}</p>` : ""}
        </div>
        <button onclick="deleteReceiving(${receiving.id}, this)" class="text-red-500 hover:text-red-700 ml-4">üóëÔ∏è</button>
      `;
      list.appendChild(li);
      form.reset();
    }
  } catch (err) {
    console.error(err);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–∏–µ–º–∫–∏');
  }
});

async function deleteReceiving(receivingId, button) {
  if (!confirm('–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø—Ä–∏–µ–º–∫—É?')) return;

  try {
    const response = await fetch(`/receivings/delete/${receivingId}`, { method: 'DELETE' });
    if (response.ok) {
      button.closest('li').remove();
    } else {
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–∏–µ–º–∫—É');
    }
  } catch (err) {
    console.error(err);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–∏–µ–º–∫–∏');
  }
}
</script>
{% endblock %}